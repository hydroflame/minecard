(()=>{let e,t,n,s,a,c={deck:{cards:[]},discard:{cards:[]},pickaxeSlot:{cards:[]},cartSlot:{cards:[]}},r=[],o={stone:0,iron:0,diamond:0,tnt:0,stairs:0};function i(){for(let e in o)document.querySelector(".inventory-slot."+e).querySelector(".current").innerText=o[e];for(let e=0;e<n.children.length;e++){let t=n.children[e];"purge"==t.dataset.ability&&(t.dataset.cost=w(),t.querySelector(".resource-count").innerText=w()),t.classList.toggle("unaffordable",!g(t))}y(),function(){const t=o.stairs,n=C/(z.length-1),s=Math.floor(t/n),a=z[s],c=t==C?a:z[s+1],r=t%n/n,i=c[0]*r+a[0]*(1-r),l=c[1]*r+a[1]*(1-r),d=c[2]*r+a[2]*(1-r);e.style.backgroundColor=`rgb(${i}, ${l}, ${d})`}()}function l(e){const t=[];for(;e.length;){const n=Math.floor(Math.random()*e.length);t.push(e[n]),e.splice(n,1)}return t}function d(){if(0==c.deck.cards.length)return;const e=c.deck.cards[c.deck.cards.length-1];r.indexOf(e)>-1||(c.deck.cards.splice(c.deck.cards.length-1,1),m(e,c.discard),e.classList.remove("face-down"),e.classList.add("flipping-up"),setTimeout((()=>{var t;"upgrade"==(t=e).dataset.resource?function(){if(c.discard.cards.length>0){let e;for(let t=c.discard.cards.length-1;t>=0;t--){const n=c.discard.cards[t];if(n.dataset.resource in o&&"stairs"!=n.dataset.resource&&parseInt(n.dataset.value)<10){e=n;break}}null!=e&&S(e,`${e.dataset.resource} ${parseInt(e.dataset.value)+1}`)}}():u(t.dataset.resource,t.dataset.value)}),300))}function u(e,t){const n=parseInt(t);if(e in o&&!isNaN(n)){const t="stairs"==e?C:q;o[e]=Math.max(0,Math.min(o[e]+n,t)),i(),"stairs"==e&&o.stairs==C&&(document.getElementById("victory").style.display="block",clearInterval(a))}}function p(e,n,s){e.cards&&e.cards.push(n);const a=e.elem.getBoundingClientRect(),c=f(s);let r=a.left-t.left+c.x,o=a.top-t.top+c.y,i=c.r;n.style.transform=`translate(${r}px,${o}px) rotate(${i}deg)`}function f(e){return{x:4*Math.random()-2,y:-2*e+(Math.random()-.5),r:4*Math.random()-2}}function m(e,t){r.push(e);const n=t.cards.length;return e.style.transition="transform 1000ms ease-in-out",e.style.zIndex=100+n,p(t,e,n),setTimeout(v.bind(e),1e3),e}function v(){this.style.zIndex-=100,this.classList.remove("flipping-up","flipping-down");const e=r.indexOf(this);var t;e>-1&&r.splice(e,1),0==c.deck.cards.length&&0==r.length&&function(){const e=l(c.discard.cards);c.discard.cards=[];for(let t=0;t<e.length;t++)e[t].classList.add("face-down","flipping-down"),m(e[t],c.deck)}(),(t=N(this.dataset))&&("pickaxe"==t.tool?(clearInterval(a),a=setInterval(d,1e3*t.timer),d()):"cart"==t.tool&&(inventorySize+=t.inventoryIncrease,i()))}function h(e){if(g(this.parentElement))if("purge"==this.parentElement.dataset.ability)!function(){s.style.display="flex";const e=s.querySelector(".card-container"),t=c.deck.cards.concat(c.discard.cards);for(let n=0;n<t.length;n++){let s=t[n].cloneNode(!0);s.style.transform=null,s.classList="card",s.onclick=b,e.appendChild(s)}y()}();else if(this.parentElement.dataset.card){u(this.parentElement.dataset.resource,-this.parentElement.dataset.cost);const e=this.parentElement.querySelector(".card"),t=$(this.parentElement.dataset.card);p({elem:e},t,0),targetPile=c.discard;const n=e.dataset.value+"Slot";if(n in c){targetPile=c[n];const t=N(e.dataset,1);!function(e,t){if(null==t)return e.classList.add("soldout"),void(e.querySelector(".buy-button").onclick=null);E(e,t);const n=e.querySelectorAll(".card");for(let e=0;e<n.length;e++)S(n[e],t.card);e.querySelector(".buy-button").innerHTML=I(t.cost),e.classList.toggle("unaffordable",!g(e))}(this.parentElement,t)}requestAnimationFrame((()=>m(t,targetPile)))}}function g(e){const t=e.dataset.resource;return!(t in o)||o[t]>=parseInt(e.dataset.cost)}function y(){if("none"!=s.style.display){const e=w();s.querySelector(".resource-count").innerText=e,s.classList.toggle("unaffordable",o.tnt<e)}}function b(){o.tnt>=w()&&(x(this.dataset,c.deck)||x(this.dataset,c.discard),u("tnt",-w()),this.classList.add("destroyed"),this.onclick=null)}function k(){s.style.display="none";const e=s.querySelector(".card-container");for(;e.firstChild;)e.removeChild(e.firstChild)}function x(e,t){for(let n=0;n<t.cards.length;n++){let s=t.cards[n];if(s.dataset.resource==e.resource&&s.dataset.value==e.value)return s.parentElement.removeChild(s),t.cards.splice(n,1),!0}return!1}function $(t){const n=L(t);return e.appendChild(n),n}function E(e,t){if(e.dataset.card=t.card,e.dataset.ability=t.ability,t.cost){const n=t.cost.split(" ");e.dataset.resource=n[0],e.dataset.cost=n[1]}}function I(e){const t=e.split(" ");return e?`\n            <span class="resource-count">${t[1]}</span>\n            <div class="resource-icon ${t[0]}"></div>\n        `:'<span class="resource-count">Free</span>'}function L(e){const t=document.createElement("div");return t.classList.add("card"),S(t,e),t}function S(e,t){let n=t.split(" "),s=n[0],a=n[1];e.innerHTML=function(e,t){let n="",s="",a="";if("stairs"==e||"upgrade"==e?(s=`<span class="name label">${e}</span>`,a="stairs"==e?'<div class="description label">Descend one level deeper.</div>':'<div class="description label">Upgrade a resource card.</div>'):isNaN(parseInt(t))?(s=`<span class="name label">${e} ${t}</span>`,a=`<div class="description label">Mines a card every ${N({resource:e,value:t}).timer}s.</div>`):(s=`<div class="top label"><span className="count">${t}</span></div>`,a=`<div class="bottom label"><span className="count">${t}</span></div>`),"pickaxe"==t)n=`<img src="img/${e}_${t}.png" />`;else for(let s=0;s<t;s++)n+=`<img src="img/${e}_icon.png" />`;return`\n        <div class="wrapper">\n            <div class="body">\n                <div class="front">\n                    ${s}\n                    <div class="content">${n}</div>\n                    ${a}\n                </div>\n                <div class="back"></div>\n            </div>\n        </div>\n    `}(s,a),e.dataset.resource=s,e.dataset.value=a}const q=999,C=100,M=[{card:"stone 1",count:8},{card:"stairs 1",count:1}],T=[{card:"old pickaxe",cost:"",level:0},{card:"stone 1",cost:"",level:1},{card:"stone 3",cost:"stone 5",level:1},{card:"stone 5",cost:"stone 20",level:1},{card:"iron 1",cost:"stone 50",level:5},{card:"iron 3",cost:"iron 5",level:5},{card:"iron 5",cost:"iron 20",level:5},{card:"diamond 1",cost:"iron 50",level:15},{card:"tnt 1",cost:"iron 1",level:10},{card:"stairs 1",cost:"diamond 5",level:5},{card:"upgrade 1",cost:"stone 30",level:5},{ability:"purge",cost:"tnt 1",level:10}],B={pickaxe:[{card:"old pickaxe",timer:1.5},{card:"stone pickaxe",cost:"stone 15",timer:1.25},{card:"iron pickaxe",cost:"iron 15",timer:1},{card:"diamond pickaxe",cost:"diamond 15",timer:.5}],cart:[{card:"stone cart",cost:"stone 10",inventoryIncrease:5}]};function N(e,t=0){if(e.value in B)for(let n=0;n<B[e.value].length;n++)if(B[e.value][n].card.startsWith(e.resource)){let s=B[e.value][n+t];return s&&(s.tool=e.value),s}}function w(){const e=c.deck.cards.concat(c.discard.cards).length;return Math.ceil(2e3/(e*e))}const z=[[165,144,108],[88,68,33],[130,73,73],[142,81,123],[102,119,199],[0,37,68]];!function(){for(let e in c)c[e].elem=document.getElementById(e);e=document.getElementById("game"),t=e.getBoundingClientRect(),n=document.getElementById("store"),s=document.getElementById("deck-screen"),s.querySelector(".close-button").onclick=k,function(){let e=[];M.forEach((function(t){for(let n=0;n<t.count;n++)e.push($(t.card))})),e=l(e);for(let t=0;t<e.length;t++)p(c.deck,e[t],t),e[t].style.zIndex=t,e[t].classList.add("face-down")}(),T.forEach((function(e){let t=function(e){const t=document.createElement("div");if(t.classList.add("product"),E(t,e),e.card)for(let n=0;n<3;n++){const s=L(e.card),a=f(n);s.style.transform=`translate(${a.x}px, ${a.y}px) rotate(${a.r}deg)`,s.style.zIndex=n,t.appendChild(s)}else if(e.ability){const n=document.createElement("div");n.classList.add(e.ability,"ability"),t.appendChild(n)}const n=document.createElement("div");return n.classList.add("buy-button"),n.innerHTML=I(e.cost),t.appendChild(n),t}(e);n.appendChild(t),t.querySelector(".buy-button").onclick=h})),i()}()})();